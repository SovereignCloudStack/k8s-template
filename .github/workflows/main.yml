name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  integration-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: engineerd/setup-kind@v0.4.0
    - name: Apply overlay
      run: kubectl apply -k envs/kind
    - name: Wait for pod to be Ready
      run: kubectl wait deployment hello-world --for=condition=Ready
    - name: Check if service is working as expected
      run: |
        OUTPUT=$(kubectl run -it --restart=Never health-checkers --rm --image=busybox --quiet -- wget -O - -q http://hello-world/env.txt)
        echo "Output: $OUTPUT"
        [[ "$OUTPUT" = "Hello world from kind" ]]
